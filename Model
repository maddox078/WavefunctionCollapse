Public Ruleset As Variant
Public Cells As Variant
Public Map As Range

Public Function Run()
    Dim X As Long
    Dim Y As Long
    Dim A As Long
    Dim B As Long
    Dim TempCell As Cell
    Dim TempRule As Rule
    Dim Ary As Variant
    Dim FinalAry As Variant
    
    Me.Initialize
    Me.GetRules
    
    X = 0
    Do While X < UBound(Cells, 1)
        Y = 0
        Do While Y < UBound(Cells, 2)
            ReDim FinalAry(0)
            
            Set TempCell = Cells(X, Y)
            
            Ary = GetAvailableOptions(TempCell)
            
            A = 0
            Do While A < UBound(Ary)
                B = 0
                Do While B < UBound(Ruleset)
                    If Ary(A).TypeA = Ruleset(B).TypeA And Ary(A).TypeB = Ruleset(B).TypeB And Ary(A).Direction = Ruleset(B).Direction Then
                        ReDim Preserve FinalAry(UBound(FinalAry) + 1)
                        Set FinalAry(UBound(FinalAry) - 1) = Ary(A)
                    End If
                    
                    B = B + 1
                Loop
                
                A = A + 1
            Loop
            
            Randomize
            Set TempRule = FinalAry(Int(UBound(FinalAry) * Rnd))
            
            TempCell.Value = TempRule.TypeA
            Set TempCell.AvailableOptions = New Collection
            TempCell.AvailableOptions.Add TempRule.TypeA
            TempCell.UpdateEntropy
            Call RestrictNeighbors(TempCell)
            
            Map.Cells(X + 1, Y + 1).Value = TempCell.Value
            
            Y = Y + 1
        Loop
        
        
        'Stop
        
        X = X + 1
    Loop
    
    
End Function

Public Function RestrictNeighbors(Target As Cell)
    Dim TempCell As Cell
    Dim Ary As Variant
    Dim TempAry As Variant
    Dim Col As New Collection
    Dim X As Long
    Dim Y As Long
    Dim Z As Long
    Dim TempVar As Variant
    Dim Flag As Boolean
    
    ReDim Ary(0)
    ReDim TempAry(0)
    
    'UP
    If Target.Y > 0 Then
        Set TempCell = Cells(Target.Y - 1, Target.X)
        Ary = GetAvailableOptions(Target)
        
        X = 0
        Do While X < UBound(Ary)
            Y = 0
            Do While Y < UBound(Ruleset)
                If Ary(X).Direction = "UP" And Ary(X).TypeA = Ruleset(Y).TypeA And Ary(X).TypeB = Ruleset(Y).TypeB Then
                    ReDim Preserve TempAry(UBound(TempAry) + 1)
                    Set TempAry(UBound(TempAry) - 1) = Ary(X)
                End If
            
                Y = Y + 1
            Loop
            
            X = X + 1
        Loop
        
        Set Col = New Collection
        
        X = 0
        Do While X < UBound(TempAry)
            Y = 1
            Flag = False
            Do Until Y > Col.Count
                If Col(Y) = TempAry(X).TypeB Then
                    Flag = True
                    Exit Do
                End If
                
                Y = Y + 1
            Loop
            
            If Flag = False Then
                Col.Add TempAry(X).TypeB
            End If
            
            X = X + 1
        Loop
        
        Set TempCell.AvailableOptions = Col
        TempCell.UpdateEntropy
        TempCell.UpdateValue
    End If
    
    'RIGHT
    If Target.X < UBound(Cells, 2) - 1 Then
        Set TempCell = Cells(Target.Y, Target.X + 1)
        Ary = GetAvailableOptions(Target)
        
        X = 0
        Do While X < UBound(Ary)
            Y = 0
            Do While Y < UBound(Ruleset)
                If Ary(X).Direction = "RIGHT" And Ary(X).TypeA = Ruleset(Y).TypeA And Ary(X).TypeB = Ruleset(Y).TypeB Then
                    ReDim Preserve TempAry(UBound(TempAry) + 1)
                    Set TempAry(UBound(TempAry) - 1) = Ary(X)
                End If
            
                Y = Y + 1
            Loop
            
            X = X + 1
        Loop
        
        Set Col = New Collection
        
        X = 0
        Do While X < UBound(TempAry)
            Y = 1
            Flag = False
            Do Until Y > Col.Count
                If Col(Y) = TempAry(X).TypeB Then
                    Flag = True
                    Exit Do
                End If
                
                Y = Y + 1
            Loop
            
            If Flag = False Then
                Col.Add TempAry(X).TypeB
            End If
            
            X = X + 1
        Loop
        
        Set TempCell.AvailableOptions = Col
        TempCell.UpdateEntropy
        TempCell.UpdateValue
    End If
    
    'DOWN
    If Target.Y < UBound(Cells, 1) - 1 Then
        Set TempCell = Cells(Target.Y + 1, Target.X)
        Ary = GetAvailableOptions(Target)
        
        X = 0
        Do While X < UBound(Ary)
            Y = 0
            Do While Y < UBound(Ruleset)
                If Ary(X).Direction = "DOWN" And Ary(X).TypeA = Ruleset(Y).TypeA And Ary(X).TypeB = Ruleset(Y).TypeB Then
                    ReDim Preserve TempAry(UBound(TempAry) + 1)
                    Set TempAry(UBound(TempAry) - 1) = Ary(X)
                End If
            
                Y = Y + 1
            Loop
            
            X = X + 1
        Loop
        
        Set Col = New Collection
        
        X = 0
        Do While X < UBound(TempAry)
            Y = 1
            Flag = False
            Do Until Y > Col.Count
                If Col(Y) = TempAry(X).TypeB Then
                    Flag = True
                    Exit Do
                End If
                
                Y = Y + 1
            Loop
            
            If Flag = False Then
                Col.Add TempAry(X).TypeB
            End If
            
            X = X + 1
        Loop
        
        Set TempCell.AvailableOptions = Col
        TempCell.UpdateEntropy
        TempCell.UpdateValue
    End If
    
    'LEFT
    If Target.X > 0 Then
        Set TempCell = Cells(Target.Y, Target.X - 1)
        Ary = GetAvailableOptions(Target)
        
        X = 0
        Do While X < UBound(Ary)
            Y = 0
            Do While Y < UBound(Ruleset)
                If Ary(X).Direction = "LEFT" And Ary(X).TypeA = Ruleset(Y).TypeA And Ary(X).TypeB = Ruleset(Y).TypeB Then
                    ReDim Preserve TempAry(UBound(TempAry) + 1)
                    Set TempAry(UBound(TempAry) - 1) = Ary(X)
                End If
            
                Y = Y + 1
            Loop
            
            X = X + 1
        Loop
        
        Set Col = New Collection
        
        X = 0
        Do While X < UBound(TempAry)
            Y = 1
            Flag = False
            Do Until Y > Col.Count
                If Col(Y) = TempAry(X).TypeB Then
                    Flag = True
                    Exit Do
                End If
                
                Y = Y + 1
            Loop
            
            If Flag = False Then
                Col.Add TempAry(X).TypeB
            End If
            
            X = X + 1
        Loop
        
        Set TempCell.AvailableOptions = Col
        TempCell.UpdateEntropy
        TempCell.UpdateValue
    End If
End Function

Public Function GetAvailableOptions(Target As Cell) As Variant
    Dim AvailableOptions As Variant
    Dim OtherTarget As Cell
    Dim Thing As Variant
    Dim SubThing As Variant
    Dim NewRule As Rule
    
    ReDim AvailableOptions(0)
    
    If Target.Y > 0 Then
        Set OtherTarget = Cells(Target.Y - 1, Target.X)
        
        For Each Thing In Target.AvailableOptions
            For Each SubThing In OtherTarget.AvailableOptions
                Set NewRule = New Rule
                'Debug.Print Thing
                
                NewRule.TypeA = Thing
                NewRule.TypeB = SubThing
                NewRule.Direction = "UP"
                
                ReDim Preserve AvailableOptions(UBound(AvailableOptions) + 1)
                Set AvailableOptions(UBound(AvailableOptions) - 1) = NewRule
            Next SubThing
        Next Thing
    End If
    
    If Target.X < UBound(Cells, 2) - 1 Then
        Set OtherTarget = Cells(Target.Y, Target.X + 1)
        
        For Each Thing In Target.AvailableOptions
            For Each SubThing In OtherTarget.AvailableOptions
                Set NewRule = New Rule
                'Debug.Print Thing
                
                NewRule.TypeA = Thing
                NewRule.TypeB = SubThing
                NewRule.Direction = "RIGHT"
                
                ReDim Preserve AvailableOptions(UBound(AvailableOptions) + 1)
                Set AvailableOptions(UBound(AvailableOptions) - 1) = NewRule
            Next SubThing
        Next Thing
    End If
    
    If Target.Y < UBound(Cells, 1) - 1 Then
        Set OtherTarget = Cells(Target.Y + 1, Target.X)
        
        For Each Thing In Target.AvailableOptions
            For Each SubThing In OtherTarget.AvailableOptions
                Set NewRule = New Rule
                'Debug.Print Thing
                
                NewRule.TypeA = Thing
                NewRule.TypeB = SubThing
                NewRule.Direction = "DOWN"
                
                ReDim Preserve AvailableOptions(UBound(AvailableOptions) + 1)
                Set AvailableOptions(UBound(AvailableOptions) - 1) = NewRule
            Next SubThing
        Next Thing
    End If
    
    If Target.X > 0 Then
        Set OtherTarget = Cells(Target.Y, Target.X - 1)
        
        For Each Thing In Target.AvailableOptions
            For Each SubThing In OtherTarget.AvailableOptions
                Set NewRule = New Rule
                'Debug.Print Thing
                
                NewRule.TypeA = Thing
                NewRule.TypeB = SubThing
                NewRule.Direction = "LEFT"
                
                ReDim Preserve AvailableOptions(UBound(AvailableOptions) + 1)
                Set AvailableOptions(UBound(AvailableOptions) - 1) = NewRule
            Next SubThing
        Next Thing
    End If
    
    GetAvailableOptions = AvailableOptions
End Function


Public Function Initialize()
    Dim X As Long
    Dim Y As Long
    Dim Rng As Range
    Dim NewCell As Cell
    
    Set Map = ActiveWorkbook.Sheets("Main").Range("Map")
    
    ReDim Cells(Map.Rows.Count, Map.Columns.Count)
    
    X = 0
    Do While X < UBound(Cells, 1)
        Y = 0
        Do While Y < UBound(Cells, 2)
            Set NewCell = New Cell
            NewCell.X = Y
            NewCell.Y = X
            NewCell.AvailableOptions.Add "L", "L"
            NewCell.AvailableOptions.Add "C", "C"
            NewCell.AvailableOptions.Add "O", "O"
            NewCell.UpdateEntropy
            NewCell.UpdateValue
            Set Cells(X, Y) = NewCell
                
            Map.Cells(X + 1, Y + 1).Value = "L,C,O,"
                
            Y = Y + 1
        Loop
        
        X = X + 1
    Loop
End Function

Public Function GetRules()
    Dim Tbl As ListObject
    Dim X As Long
    Dim NewRule As Rule
    
    Set Tbl = ActiveWorkbook.Sheets("Truths").ListObjects("Truths")
    
    ReDim Ruleset(Tbl.ListRows.Count)
    
    X = 1
    Do Until X > Tbl.ListRows.Count
        Set NewRule = New Rule
        NewRule.TypeA = Tbl.DataBodyRange(X, 1).Value
        NewRule.TypeB = Tbl.DataBodyRange(X, 2).Value
        NewRule.Direction = Tbl.DataBodyRange(X, 3).Value
        Set Ruleset(X - 1) = NewRule
        
        X = X + 1
    Loop
End Function


